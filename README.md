# Generation of interactive mapscape plots from NDP clustering/trees

## This branch is for generating signature annotated interactive [plots](example/PD39939_GitLab_example_mapscape_220425.html)

## Process
Run locally on your machine

## Requirements
 1. .png formmated static image of histology section microbiopsier were generated from 
![PD39939](example/PD39939_combo_img.png "H&E Image")

2. table indicating x/y pixel position of each microbiopsy
    - I generate these using photoshop determining the position of my cursor
    - The location_id field must be unique

![location_tbl](example_images/ "Location_Table") 

3. Signature-annotated tree and optionally a second tree (for example with and without tumours plotted). The signature tree file is expected to be in the same directory as the H&E image, be .png formatted, and be named:
    - first 7 characters "_SigFit_annotated.png"
    - PD39939_SigFit_annotated.png

![sig_tree](example/PD39939_SigFit_annotated.png "Signature Tree")

If a second file is given, it is expected to be:
- first 7 characters "_static_tree.png"
- PD39939_static_tree.png
In this case this is the tree without the siganture annotation and with the tumour samples removed.

![static_tree](example/PD39939_static_tree.png "Static Tree")

The first tree will be the one plotted on the interactive plot

4.  Clonal Prevelence table, detailing how much of each clone each microbipsy sample has. By default this is generated by the ndp clustering as the "cluster_and_samples.csv" file

![prev_tbl](example_images/Clonal_prev.png "Prevelence_Table") 

5.  Cluster and spectrum plots pdf, for display the clustering from NDP. By default this is generated by the ndp clustering as the "Cluster_and_spectrum_plots.pdf" file. This needs to be in the same directory as the "Prevelance Table"

![clust_spec](example/Cluster_and_spectrum_plots.pdf "Cluster and Spectrum")

6. Edge table from NDP tree of clone structure. Generated automatically by the ndp tree building script.

![edge_tbl](example_images/edge_tbl.png "Edge_Table") 

7. .phlyo Tree of same tree, used for determining colour scheme. It is expected to have the be in the same directory as the edge table, ending in .phylo and share the first 7 characters (PD39939). 

8. Optionally, a mutaiton table indicating the mutations, vaf, and cluster assignment of each mutation in each sample. Generated by default by ndp tree building. For display, mutations will be filtered to only include those that are protein-altering. 
required columns:
- Chrom
- Coord
- Gene
- Protein
- Effect 
- Driver
- cluster_id

![mapscape](example_images/mapscape.png "Mapscape") 

## Notes
- For simplicity sample names are shortened to just the last 6 digits, rather than full names. So PD39939c_lo0013 beceomes c_lo0013. Sample names used in location table should reflect this.
- Samples which do not have any clone present at >= 0.01 will be removed, otherwise mapscape fails to generate an image
- Visualisation of the clones present in a sample doesn't truely reflect the nesting of clones within each other. Nor does it allow for a sample to be filled in at less than 100%. This is on the list of things to fix.
- Plotting parameters (size of trees, size of image etc) are mostly handled by the underlying javascript file and are not currently parameters. This is on the list of things to fix. 

## Javascript files
- I have updated the javascript files installed by mapscape to improve the visualisation of the plotting. This is very much a work in progress. 
    - The updated javascript files are in the javascript_files folder. To implement these you need to overwrite the one installed by default
    - /Library/R/4.0(or whatever R version you have)/library/mapscape/htmlwidgets/mapscape.js
    - /Library/R/4.0(or whatever R version you have)/library/mapscape/htmlwidgets/lib/mapscape_helpers.js
    - in the file i have commented (search tb14) what changes I made and why, additional optimisation is likely possible. Ideally would make some of those paramenters that can be set by R rather than by edited the script.

## Usage
To be run locally on your machine rather than on the farm, should take less than a min to run

```
./mapscape_generation.sh
- SAMPLE_NAME
- IMAGE_FILE (must be .png formatted)
- LOCATION_TABLE (x/y pixel positions of micropsies on .png image)
- CLONAL_PREVELANCE_TABLE (cluster_and_samples.csv output by ndp clustering)
- EDGE_TBL (tree edge table output by ndp tree generation)
- LOW_PREV (TRUE or FALSE, whether to include only clones present >0.01, reccomened FALSE)
- OUTPUT_DIRECTORY (where .html output file will be saved)
- MUTATION_TABLE (Option paramenter, table of annotated mutaitons and which samples, and clones those are assigned to)
```
```
./mapscape_generation.sh \
PD39939_GitLab_Example
example/PD39939_combo_img.png \
example/PD39939_loc_tbl.xlsx \
example/cluster_and_samples.csv \
example/PD39939.edge_tbl.csv \
FALSE \
example/ \
example/PD39939_ndp_assigned_muts_final.csv
```